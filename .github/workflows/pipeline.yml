name: ⚽ Football ML Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 1"  # Lunes a las 6 AM hora de México (12:00 UTC)

jobs:
  run-football-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔑 Set environment variables
        run: |
          echo "FOOTBALL_API_KEY=${{ secrets.FOOTBALL_API_KEY }}" >> $GITHUB_ENV

      - name: 🧠 Create credentials file
        run: |
          mkdir -p config
          echo '{"api_key": "${{ secrets.FOOTBALL_API_KEY }}"}' > config/credentials.json

      - name: 🚀 Starting automated Football ML pipeline...
        run: |
          mkdir -p data/raw data/processed logs reports
          echo "📥 Running data ingestion..."
          python3 scripts/01_data_ingestion_global.py || echo "⚠️ Data ingestion skipped or partially failed."
          echo "⚙️ Running feature engineering..."
          python3 scripts/02_feature_engineering.py || echo "⚠️ Feature engineering issue."
          echo "🎯 Adding targets..."
          python3 scripts/05_add_targets.py || echo "⚠️ Target generation issue."

      - name: 🔍 Debug Data
        run: |
          echo "Archivos en data/processed:"
          ls -la data/processed/ | head -10
          echo "Columnas en features_with_targets_latest.csv:"
          python -c "import pandas as pd; df=pd.read_csv('data/processed/features_with_targets_latest.csv', nrows=0); print(df.columns.tolist())"
          echo "Contenido inicial de model_training_log.csv:"
          if [ -f logs/model_training_log.csv ]; then
            head -n 10 logs/model_training_log.csv
          else
            echo "Archivo no encontrado"
          fi

      - name: 📊 Running model training...
        run: |
          python3 scripts/03_modeling.py || echo "⚠️ Modeling issue."

      - name: 🔁 Cross-validation
        run: |
          python3 scripts/07_cross_validation.py || echo "⚠️ Cross-validation issue."

      - name: 📈 Evaluate models
        run: |
          python3 scripts/06_evaluate_models.py || echo "⚠️ Evaluation issue."

      - name: ✅ Final message
        run: echo "✅ Pipeline completed successfully!"
