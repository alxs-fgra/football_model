name: âš½ Football ML Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 1"  # Lunes 06:00 AM hora CDMX (12:00 UTC)

jobs:
  run-football-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”‘ Export API key & credentials
        run: |
          echo "FOOTBALL_API_KEY=${{ secrets.FOOTBALL_API_KEY }}" >> $GITHUB_ENV
          mkdir -p config
          echo "{\"api_key\": \"${{ secrets.FOOTBALL_API_KEY }}\"}" > config/credentials.json
          echo "âœ… API key exported and credentials.json created"

      - name: ğŸš€ Run pipeline (ingest -> features -> targets)
        run: |
          mkdir -p data/raw data/processed logs reports
          echo "ğŸ“¥ Running data ingestion..."
          python3 scripts/01_data_ingestion_global.py || echo "âš ï¸ Data ingestion skipped or partially failed."
          echo "âš™ï¸ Running feature engineering..."
          python3 scripts/02_feature_engineering.py || echo "âš ï¸ Feature engineering issue."
          echo "ğŸ¯ Adding targets..."
          python3 scripts/05_add_targets.py || echo "âš ï¸ Target generation issue."

      - name: ğŸ” Debug Data
        run: |
          echo "ğŸ“‚ Archivos en data/processed:"
          if [ -d data/processed ]; then
            ls -la data/processed/ | head -50
          else
            echo "âš ï¸ Directorio data/processed no encontrado"
          fi
          echo "ğŸ§  Detectando archivo mÃ¡s reciente..."
          LATEST=$(ls -t data/processed/features_with_targets_*.csv 2>/dev/null | head -1)
          if [ -z "$LATEST" ]; then
            echo "âŒ No se encontrÃ³ ningÃºn archivo features_with_targets_*.csv"
            exit 1
          fi
          echo "Archivo detectado: $LATEST"
          export LATEST="$LATEST"
          echo "LATEST=$LATEST" >> $GITHUB_ENV
          echo "ğŸ§¾ Columnas:"
          python -c "import pandas as pd, os; df=pd.read_csv(os.environ['LATEST'], nrows=0); print(df.columns.tolist())" || echo "âš ï¸ No se pudieron leer columnas."
          echo "ğŸ“Š Contenido inicial de logs/model_training_log.csv:"
          if [ -f logs/model_training_log.csv ]; then
            head -n 10 logs/model_training_log.csv
          else
            echo "Archivo no encontrado"
          fi

      - name: ğŸ“Š Train models
        run: |
          echo "Usando dataset mÃ¡s reciente: $LATEST"
          python3 scripts/03_modeling.py || echo "âš ï¸ Modeling issue."

      - name: ğŸ” Cross-validation
        run: |
          python3 scripts/07_cross_validation.py || echo "âš ï¸ Cross-validation issue."

      - name: ğŸ“ˆ Evaluate models
        run: |
          if [ -f logs/model_training_log.csv ]; then
            python3 scripts/06_evaluate_models.py || echo "âš ï¸ Evaluation issue."
          else
            echo "âš ï¸ Skipping evaluation: model_training_log.csv not found."
          fi

      - name: âœ… Final message
        run: echo "âœ… Pipeline completed successfully!"
