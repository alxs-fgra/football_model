name: âš½ Football ML Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * 1"  # Lunes a las 6 AM hora de MÃ©xico (12:00 UTC)

jobs:
  run-football-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”‘ Set environment variables
        run: |
          echo "FOOTBALL_API_KEY=${{ secrets.FOOTBALL_API_KEY }}" >> $GITHUB_ENV

      - name: ğŸ§  Create credentials file
        run: |
          mkdir -p config
          echo '{"api_key": "${{ secrets.FOOTBALL_API_KEY }}"}' > config/credentials.json

      - name: ğŸš€ Starting automated Football ML pipeline...
        run: |
          mkdir -p data/raw data/processed logs reports
          echo "ğŸ“¥ Running data ingestion..."
          python3 scripts/01_data_ingestion_global.py || echo "âš ï¸ Data ingestion skipped or partially failed."
          echo "âš™ï¸ Running feature engineering..."
          python3 scripts/02_feature_engineering.py || echo "âš ï¸ Feature engineering issue."
          echo "ğŸ¯ Adding targets..."
          python3 scripts/05_add_targets.py || echo "âš ï¸ Target generation issue."

      - name: ğŸ” Debug Data
        run: |
          echo "Archivos en data/processed:"
          ls -la data/processed/ | head -10
          echo "Columnas en features_with_targets_latest.csv:"
          python -c "import pandas as pd; df=pd.read_csv('data/processed/features_with_targets_latest.csv', nrows=0); print(df.columns.tolist())"
          echo "Contenido inicial de model_training_log.csv:"
          if [ -f logs/model_training_log.csv ]; then
            head -n 10 logs/model_training_log.csv
          else
            echo "Archivo no encontrado"
          fi

      - name: ğŸ“Š Running model training...
        run: |
          python3 scripts/03_modeling.py || echo "âš ï¸ Modeling issue."

      - name: ğŸ” Cross-validation
        run: |
          python3 scripts/07_cross_validation.py || echo "âš ï¸ Cross-validation issue."

      - name: ğŸ“ˆ Evaluate models
        run: |
          python3 scripts/06_evaluate_models.py || echo "âš ï¸ Evaluation issue."

      - name: âœ… Final message
        run: echo "âœ… Pipeline completed successfully!"
